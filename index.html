<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–°–∫–ª–∞–¥—ã ‚Äî –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (—á/–±)</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
  <button class="tab-btn active" data-section="buffer">–ë—É—Ñ—Ñ–µ—Ä–Ω —Å–∫–ª–∞–¥ –°–ü–û</button>
  <button class="tab-btn" data-section="south">–Æ–∂–Ω—ã–π —Å–∫–ª–∞–¥ –∞–Ω–æ–¥–æ–≤ –û–û</button>
  <button class="tab-btn" data-section="north">–°–µ–≤–µ—Ä–Ω—ã–π —Å–∫–ª–∞–¥ –∞–Ω–æ–¥–æ–≤ –û–û</button>
  <button class="tab-btn" data-section="ready">–°–∫–ª–∞–¥ –≥–æ—Ç–æ–≤–æ–π –ø—Ä–æ–¥—É–∫—Ü–∏–∏</button>
  <div style="flex:1"></div>
  <div class="pill" id="tz-indicator">–í–æ–ª–≥–æ–≥—Ä–∞–¥</div>
  <img id="settings-btn" class="settings-btn-img" src="settings.png" alt="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" role="button" tabindex="0">
</header>

<main class="container">
  <section id="buffer" class="section active"></section>
  <section id="south" class="section"></section>
  <section id="north" class="section"></section>
  <section id="ready" class="section"></section>
</main>

<div id="fullscreen" class="fullscreen" aria-hidden="true">
  <span class="close-btn" role="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">&times;</span>
  <img src="" alt="Full Image">
</div>

<script>
const MOSCOW_TZ = "Europe/Moscow";
const sectionImages = {
  buffer: "1.jpg",
  south: "2.jpg",
  north: "3.jpg",
  ready: "4.jpg"
};

function fmtDateInTZ(date){
  return new Intl.DateTimeFormat("ru-RU", { timeZone: MOSCOW_TZ, day: "2-digit", month:"2-digit", year:"numeric" }).format(date);
}
function fmtTimeInTZ(date){
  return new Intl.DateTimeFormat("ru-RU", { timeZone: MOSCOW_TZ, hour: "2-digit", minute:"2-digit", second:"2-digit" }).format(date);
}
function getHourInTZ(date){
  const parts = new Intl.DateTimeFormat("en-US", { timeZone: MOSCOW_TZ, hour: "2-digit", hour12:false }).formatToParts(date);
  for(const p of parts) if(p.type==="hour") return Number(p.value);
  return date.getUTCHours();
}
function getShiftForHour(h) {
  if (h >= 7 && h < 12) return "–£—Ç—Ä–µ–Ω–Ω—è—è";
  if (h >= 12 && h < 19) return "–î–Ω–µ–≤–Ω–∞—è";
  return "–ù–æ—á–Ω–∞—è";
}

function openFullscreen(src){
  const fs = document.getElementById("fullscreen");
  fs.style.display="flex"; fs.setAttribute("aria-hidden","false");
  fs.querySelector("img").src = src;
}
document.querySelector(".close-btn").addEventListener("click", ()=>{ const fs = document.getElementById("fullscreen"); fs.style.display="none"; fs.setAttribute("aria-hidden","true"); });
document.getElementById("fullscreen").addEventListener("click",(e)=>{ if(e.target.id==="fullscreen") { e.currentTarget.style.display="none"; e.currentTarget.setAttribute("aria-hidden","true"); } });

function createSection(id, title){
  const container = document.getElementById(id);
  container.innerHTML = `
    <div class="content" role="region" aria-label="${title}">
      <div class="camera" tabindex="0" aria-label="–ö–∞–º–µ—Ä–∞ ${title}">
        <img src="${sectionImages[id]}" alt="–ö–∞–º–µ—Ä–∞ ${title}">
      </div>
      <div class="info" aria-live="polite">
        <div class="row"><div><small>–î–∞—Ç–∞</small></div><div class="big" id="${id}-date">-</div></div>
        <div class="row"><div><small>–í—Ä–µ–º—è (–ú–°–ö)</small></div><div class="big" id="${id}-time">-</div></div>
        <div class="row"><div><small>–°–º–µ–Ω–∞</small></div><div id="${id}-shift" class="big">-</div></div>
        <div class="row"><div><small>–ö–æ–ª-–≤–æ –≥—Ä—É–∑–æ–≤–∏–∫–æ–≤</small></div><div id="${id}-trucks">0</div></div>
        <div class="row"><div><small>–ó–∞–≤–µ–∑–µ–Ω–æ</small></div><div id="${id}-in">–ø–∞–∫–µ—Ç–æ–≤: 0 / –∞–Ω–æ–¥–æ–≤: 0</div></div>
        <div class="row"><div><small>–í—ã–≤–µ–∑–µ–Ω–æ</small></div><div id="${id}-out">–ø–∞–∫–µ—Ç–æ–≤: 0 / –∞–Ω–æ–¥–æ–≤: 0</div></div>
      </div>
    </div>
    <div style="height:12px"></div>
    <div style="overflow:auto">
      <table aria-describedby="${title}">
        <thead>
          <tr>
            <th>‚Ññ</th><th>–ü—Ä–∏–±—ã–ª</th><th>–§–æ—Ç–æ</th><th>–£–±—ã–ª</th>
            <th>–ó–∞–≤–µ–∑–µ–Ω–æ –ø–∞–∫–µ—Ç–æ–≤</th><th>–ó–∞–≤–µ–∑–µ–Ω–æ –∞–Ω–æ–¥–æ–≤</th>
            <th>–í—ã–≤–µ–∑–µ–Ω–æ –ø–∞–∫–µ—Ç–æ–≤</th><th>–í—ã–≤–µ–∑–µ–Ω–æ –∞–Ω–æ–¥–æ–≤</th>
          </tr>
        </thead>
        <tbody id="${id}-tbody">
          <tr><td colspan="8" class="no-data">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>
        </tbody>
      </table>
    </div>
  `;

  const cam = container.querySelector(".camera");
  const img = cam.querySelector("img");
  cam.addEventListener("click", ()=> openFullscreen(img.src));
  cam.addEventListener("keydown", (e)=> { if(e.key==="Enter"||e.key===" ") openFullscreen(img.src); });
}

const sections = { buffer: "–ë—É—Ñ—Ñ–µ—Ä–Ω —Å–∫–ª–∞–¥ –°–ü–û", south: "–Æ–∂–Ω—ã–π —Å–∫–ª–∞–¥ –∞–Ω–æ–¥–æ–≤ –û–û", north: "–°–µ–≤–µ—Ä–Ω—ã–π —Å–∫–ª–∞–¥ –∞–Ω–æ–¥–æ–≤ –û–û", ready: "–°–∫–ª–∞–¥ –≥–æ—Ç–æ–≤–æ–π –ø—Ä–æ–¥—É–∫—Ü–∏–∏" };
Object.entries(sections).forEach(([id,title])=> createSection(id,title));

// Initial state is the markup defaults (first tab/section active).
// Do not restore from sessionStorage here ‚Äî always show the first section on load.

document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
    document.getElementById(btn.dataset.section).classList.add("active");
    // Do not persist selection to sessionStorage here ‚Äî keep main page default behavior
  });
});

async function updateDashboard(){
  const now = new Date();
  const dateStr = fmtDateInTZ(now);
  const timeStr = fmtTimeInTZ(now);
  const hour = getHourInTZ(now);

  Object.keys(sections).forEach(id=>{
    document.getElementById(`${id}-date`).textContent = dateStr;
    document.getElementById(`${id}-time`).textContent = timeStr;
    document.getElementById(`${id}-shift`).textContent = getShiftForHour(hour);
  });

  try{
    const resp = await fetch('api.php', { cache: "no-store" });
    if(!resp.ok) {
      console.error("–û—à–∏–±–∫–∞ API:", resp.status, resp.statusText);
      return;
    }
    const data = await resp.json();

    Object.keys(sections).forEach(id=>{
      const section = data[id] || { trucks:0, in:0, out:0, arrivals:[] };
      const arrivals = section.arrivals || [];
      
      // –°—á–∏—Ç–∞–µ–º –æ–±—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç—É—Å–∞ arrivals (status_name)
      let totalInPackages = 0;   // "–ó–∞–≤–µ–∑–µ–Ω–æ –ø–∞–∫–µ—Ç–æ–≤" (–≤—ã–≥—Ä—É–∑–∫–∞)
      let totalInBlocks = 0;     // "–ó–∞–≤–µ–∑–µ–Ω–æ –∞–Ω–æ–¥–æ–≤" (–≤—ã–≥—Ä—É–∑–∫–∞)
      let totalOutPackages = 0;  // "–í—ã–≤–µ–∑–µ–Ω–æ –ø–∞–∫–µ—Ç–æ–≤" (–∑–∞–≥—Ä—É–∑–∫–∞)
      let totalOutBlocks = 0;    // "–í—ã–≤–µ–∑–µ–Ω–æ –∞–Ω–æ–¥–æ–≤" (–∑–∞–≥—Ä—É–∑–∫–∞)
      // –ë–µ—Ä—ë–º –∑–Ω–∞—á–µ–Ω–∏–µ trucks –∏–∑ API (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ–∫—É—â–∏—Ö –≥—Ä—É–∑–æ–≤–∏–∫–æ–≤)
      let trucks = section.trucks ?? 0;

      arrivals.forEach(a => {
        const packages = a.packages_count ?? 0;
        const blocks = a.blocks_sum ?? 0;
        const status = (a.status_name || '').toLowerCase();

        if (status === '–≤—ã–≥—Ä—É–∑–∫–∞') {
          // —Ä–∞–∑–≥—Ä—É–∑–∫–∞ = –∑–∞–≤–µ–∑–µ–Ω–æ –Ω–∞ —Å–∫–ª–∞–¥
          totalInPackages += packages;
          totalInBlocks += blocks;
        } else if (status === '–∑–∞–≥—Ä—É–∑–∫–∞') {
          // –∑–∞–≥—Ä—É–∑–∫–∞ = –≤—ã–≤–µ–∑–µ–Ω–æ —Å–æ —Å–∫–ª–∞–¥–∞
          totalOutPackages += packages;
          totalOutBlocks += blocks;
        } else {
          // –ø—Ä–æ—Å—Ç–æ–π –∏–ª–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å ‚Äî –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ–º
        }
      });

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–¥–Ω—ã–µ —Ü–∏—Ñ—Ä—ã
      document.getElementById(`${id}-trucks`).textContent = trucks;
      document.getElementById(`${id}-in`).textContent = `–ø–∞–∫–µ—Ç–æ–≤: ${totalInPackages} / –∞–Ω–æ–¥–æ–≤: ${totalInBlocks}`;
      document.getElementById(`${id}-out`).textContent = `–ø–∞–∫–µ—Ç–æ–≤: ${totalOutPackages} / –∞–Ω–æ–¥–æ–≤: ${totalOutBlocks}`;

      // –¢–∞–±–ª–∏—Ü–∞ arrivals
      const tbody = document.getElementById(`${id}-tbody`);
      
      if(arrivals.length === 0){
        tbody.innerHTML = '<tr><td colspan="8" class="no-data">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
      } else {
        let rows = '';
        arrivals.forEach((a, idx) => {
          let arrivedDisplay = '‚Äî';
          if (a.arrived_at) {
            const d = new Date(a.arrived_at.replace(' ', 'T'));
            arrivedDisplay = `${fmtDateInTZ(d)} ${fmtTimeInTZ(d)}<div class="muted">${a.state_number || ''}</div>`;
          } else {
            arrivedDisplay = a.state_number ? `<div class="muted">${a.state_number}</div>` : '‚Äî';
          }

          let departedDisplay = '‚Äî';
          if (a.departed_at && a.departed_at !== 'NULL') {
            const d2 = new Date(a.departed_at.replace(' ', 'T'));
            departedDisplay = `${fmtDateInTZ(d2)} ${fmtTimeInTZ(d2)}`;
          }

          let photoCell = '‚Äî';
          if (a.arrived_photo) {
            photoCell = `<img class="tiny" src="${a.arrived_photo}" alt="in" onclick="openFullscreen(this.src)">`;
          } else {
            photoCell = 'üì∑';
          }

          // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–∞–∫–µ—Ç—ã/–±–ª–æ–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ (status_name)
          const arrivalStatus = (a.status_name || '').toLowerCase();
          const total_packages = a.packages_count ?? 0;
          const total_blocks = a.blocks_sum ?? 0;
          let in_packages = 0, in_blocks = 0, out_packages = 0, out_blocks = 0;

          if (arrivalStatus === '–≤—ã–≥—Ä—É–∑–∫–∞') {
            // —Ä–∞–∑–≥—Ä—É–∑–∫–∞ => –∑–∞–≤–µ–∑–µ–Ω–æ
            in_packages = total_packages;
            in_blocks = total_blocks;
          } else if (arrivalStatus === '–∑–∞–≥—Ä—É–∑–∫–∞') {
            // –∑–∞–≥—Ä—É–∑–∫–∞ => –≤—ã–≤–µ–∑–µ–Ω–æ
            out_packages = total_packages;
            out_blocks = total_blocks;
          } else {
            // –ø—Ä–æ—Å—Ç–æ–π –∏–ª–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π ‚Äî –≤—Å—ë 0
          }

          rows += `<tr>
            <td>${idx+1}</td>
            <td class="left">${arrivedDisplay}</td>
            <td>${photoCell}</td>
            <td class="left">${departedDisplay}</td>
            <td>${in_packages}</td>
            <td>${in_blocks}</td>
            <td>${out_packages}</td>
            <td>${out_blocks}</td>
          </tr>`;
        });
        tbody.innerHTML = rows;
      }
    });

  } catch(e){
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:", e);
  }
}

updateDashboard();
setInterval(updateDashboard, 2000);

function flash(msg, ms=2500){
  let el = document.createElement("div");
  el.textContent = msg;
  el.style.position="fixed"; el.style.left="50%"; el.style.bottom="22px"; el.style.transform="translateX(-50%)";
  el.style.background="#111"; el.style.color="#fff"; el.style.padding="10px 14px"; el.style.borderRadius="8px"; el.style.zIndex=10000;
  document.body.appendChild(el); setTimeout(()=>el.remove(), ms);
}

flash("–í—Ä–µ–º—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø–æ –ú–æ—Å–∫–æ–≤—Å–∫–æ–º—É —á–∞—Å–æ–≤–æ–º—É –ø–æ—è—Å—É (MSK).");

(function addKeyboardNav(){
  const tabs = Array.from(document.querySelectorAll(".tab-btn"));
  tabs.forEach((t,i)=> t.addEventListener("keydown",(e)=>{
    if(e.key==="ArrowRight"){ tabs[(i+1)%tabs.length].focus();}
    if(e.key==="ArrowLeft"){ tabs[(i-1+tabs.length)%tabs.length].focus();}
  }));
})();

// Navigate to settings page on button click
(() => {
  const btn = document.getElementById('settings-btn');
  if(!btn) return;

  btn.addEventListener('click', (e)=>{
    e.stopPropagation();
    // rotate the image
    btn.classList.add('rotating');
    // save current section to sessionStorage
    const activeSection = document.querySelector('.section.active');
    if(activeSection) {
      sessionStorage.setItem('currentSection', activeSection.id);
    }
    // fade out and navigate
    document.body.style.opacity = '0';
    document.body.style.transition = 'opacity 200ms ease';
    setTimeout(()=> { window.location.href = 'settings.html'; }, 200);
  });
})();
</script>
</body>
</html>