<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–°–∫–ª–∞–¥—ã ‚Äî –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (—á/–±)</title>
  <style>
    :root {
      --bg: #f5f5f5;
      --panel: #fff;
      --muted: #ccc;
      --dark: #111;
      --mid: #666;
      --accent: #222;
      --glass: rgba(255,255,255,0.04);
    }
    html,body {height:100%; margin:0; font-family: Inter, Arial, Helvetica, sans-serif; background: linear-gradient(180deg,var(--bg),#eee); color: var(--dark); -webkit-font-smoothing:antialiased;}
    header {display:flex; gap:6px; align-items:center; padding:10px; background:#222; color:#fff; box-shadow:0 2px 6px rgba(0,0,0,0.4); position:sticky; top:0; z-index:100;}
    .tab-btn {background:transparent; color:#fff; border:1px solid rgba(255,255,255,0.06); padding:10px 16px; cursor:pointer; border-radius:8px; transition:all 180ms ease; font-weight:600;}
    .tab-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.35);}
    .tab-btn.active {background:#555;}
    main.container {padding:20px; max-width:1200px; margin:16px auto;}
    .section {display:none; padding:18px; gap:18px;}
    .section.active {display:flex; flex-direction:column;}
    .content {display:flex; gap:18px; flex-wrap:wrap; align-items:flex-start;}
    .camera {width:420px; min-width:280px; height:320px; background:var(--muted); display:flex; justify-content:center; align-items:center; cursor:pointer; overflow:hidden; border-radius:8px; border:2px solid rgba(0,0,0,0.07); box-shadow: 0 6px 18px rgba(0,0,0,0.12) inset;}
    .camera img {width:100%; height:100%; object-fit:cover; display:block;}
    .info {flex:1; min-width:260px; display:flex; flex-direction:column; gap:10px;}
    .info .row {display:flex; gap:10px; align-items:center; justify-content:space-between; padding:10px; background:var(--panel); border-radius:8px;}
    .info .row small {color:var(--mid);}
    .info .big {font-size:1.15rem; font-weight:700;}
    table {width:100%; border-collapse:collapse; background:var(--panel); border-radius:8px; overflow:hidden;}
    thead {background: #f1f1f1;}
    th,td {padding:8px 6px; border-bottom:1px solid #e6e6e6; text-align:center; font-size:0.95rem;}
    tbody tr:hover {background: rgba(0,0,0,0.02);}
    tbody {max-height:320px; display:block; overflow:auto;}
    thead, tbody tr {display:table; width:100%; table-layout:fixed;}
    thead th {padding:10px; font-weight:700;}
    .fullscreen {position:fixed; inset:0; background:rgba(0,0,0,0.92); display:none; align-items:center; justify-content:center; z-index:9999;}
    .fullscreen img {max-width:92%; max-height:92%; border-radius:8px; box-shadow: 0 10px 50px rgba(0,0,0,0.7);}
    .close-btn {position:absolute; top:18px; right:22px; color:#fff; font-size:34px; cursor:pointer;}
    @media (max-width:900px){.camera{ width:100%; height:220px;} .content{ flex-direction:column;} tbody{ max-height:220px;}}
    tbody::-webkit-scrollbar{width:10px;} tbody::-webkit-scrollbar-thumb{background:linear-gradient(180deg,#ddd,#bbb); border-radius:8px;}
    .muted { color:var(--mid); } .pill{ background:#222; color:#fff; padding:6px 10px; border-radius:999px; font-size:0.85rem; }
    img.tiny { height:48px; max-width:120px; object-fit:cover; cursor:pointer; border-radius:4px; }
    td.left { text-align:left; padding-left:8px; }
  </style>
</head>
<body>
<header>
  <button class="tab-btn active" data-section="buffer">–ë—É—Ñ—Ñ–µ—Ä–Ω —Å–∫–ª–∞–¥ –°–ü–û</button>
  <button class="tab-btn" data-section="south">–Æ–∂–Ω—ã–π —Å–∫–ª–∞–¥ –∞–Ω–æ–¥–æ–≤ –û–û</button>
  <button class="tab-btn" data-section="north">–°–µ–≤–µ—Ä–Ω—ã–π —Å–∫–ª–∞–¥ –∞–Ω–æ–¥–æ–≤ –û–û</button>
  <button class="tab-btn" data-section="ready">–°–∫–ª–∞–¥ –≥–æ—Ç–æ–≤–æ–π –ø—Ä–æ–¥—É–∫—Ü–∏–∏</button>
  <div style="flex:1"></div>
  <div class="pill" id="tz-indicator">–í–æ–ª–≥–æ–≥—Ä–∞–¥</div>
</header>

<main class="container">
  <section id="buffer" class="section active"></section>
  <section id="south" class="section"></section>
  <section id="north" class="section"></section>
  <section id="ready" class="section"></section>
</main>

<div id="fullscreen" class="fullscreen" aria-hidden="true">
  <span class="close-btn" role="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">&times;</span>
  <img src="" alt="Full Image">
</div>

<script>
const MOSCOW_TZ = "Europe/Moscow";
const sectionImages = {
  buffer: "1.jpg",
  south: "2.jpg",
  north: "3.jpg",
  ready: "4.jpg"
};

function fmtDateInTZ(date){
  return new Intl.DateTimeFormat("ru-RU", { timeZone: MOSCOW_TZ, day: "2-digit", month:"2-digit", year:"numeric" }).format(date);
}
function fmtTimeInTZ(date){
  return new Intl.DateTimeFormat("ru-RU", { timeZone: MOSCOW_TZ, hour: "2-digit", minute:"2-digit", second:"2-digit" }).format(date);
}
function getHourInTZ(date){
  const parts = new Intl.DateTimeFormat("en-US", { timeZone: MOSCOW_TZ, hour: "2-digit", hour12:false }).formatToParts(date);
  for(const p of parts) if(p.type==="hour") return Number(p.value);
  return date.getUTCHours();
}
function getShiftForHour(h) {
  // –£—Ç—Ä–µ–Ω–Ω—è—è: 07:00 ‚Äî 12:00
  if (h >= 7 && h < 12) return "–£—Ç—Ä–µ–Ω–Ω—è—è";

  // –î–Ω–µ–≤–Ω–∞—è: 12:00 ‚Äî 19:00
  if (h >= 12 && h < 19) return "–î–Ω–µ–≤–Ω–∞—è";

  // –ù–æ—á–Ω–∞—è: 19:00 ‚Äî 24:00 –∏ 00:00 ‚Äî 07:00
  return "–ù–æ—á–Ω–∞—è";
}

function openFullscreen(src){
  const fs = document.getElementById("fullscreen");
  fs.style.display="flex"; fs.setAttribute("aria-hidden","false");
  fs.querySelector("img").src = src;
}
document.querySelector(".close-btn").addEventListener("click", ()=>{ const fs = document.getElementById("fullscreen"); fs.style.display="none"; fs.setAttribute("aria-hidden","true"); });
document.getElementById("fullscreen").addEventListener("click",(e)=>{ if(e.target.id==="fullscreen") { e.currentTarget.style.display="none"; e.currentTarget.setAttribute("aria-hidden","true"); } });

function createSection(id, title){
  const container = document.getElementById(id);
  container.innerHTML = `
    <div class="content" role="region" aria-label="${title}">
      <div class="camera" tabindex="0" aria-label="–ö–∞–º–µ—Ä–∞ ${title}">
        <img src="${sectionImages[id]}" alt="–ö–∞–º–µ—Ä–∞ ${title}">
      </div>
      <div class="info" aria-live="polite">
        <div class="row"><div><small>–î–∞—Ç–∞</small></div><div class="big" id="${id}-date">-</div></div>
        <div class="row"><div><small>–í—Ä–µ–º—è (–ú–°–ö)</small></div><div class="big" id="${id}-time">-</div></div>
        <div class="row"><div><small>–°–º–µ–Ω–∞</small></div><div id="${id}-shift" class="big">-</div></div>
        <div class="row"><div><small>–ö–æ–ª-–≤–æ –≥—Ä—É–∑–æ–≤–∏–∫–æ–≤</small></div><div id="${id}-trucks">?</div></div>
        <div class="row"><div><small>–ó–∞–≤–µ–∑–µ–Ω–æ</small></div><div id="${id}-in">–ø–∞–∫–µ—Ç–æ–≤: ? / –∞–Ω–æ–¥–æ–≤: ?</div></div>
        <div class="row"><div><small>–í—ã–≤–µ–∑–µ–Ω–æ</small></div><div id="${id}-out">–ø–∞–∫–µ—Ç–æ–≤: ? / –∞–Ω–æ–¥–æ–≤: ?</div></div>
      </div>
    </div>
    <div style="height:12px"></div>
    <div style="overflow:auto">
      <table aria-describedby="${title}">
        <thead>
          <tr>
            <th>‚Ññ</th><th>–ü—Ä–∏–±—ã–ª</th><th>–§–æ—Ç–æ</th><th>–£–±—ã–ª</th>
            <th>–ó–∞–≤–µ–∑–µ–Ω–æ –ø–∞–∫–µ—Ç–æ–≤</th><th>–ó–∞–≤–µ–∑–µ–Ω–æ –∞–Ω–æ–¥–æ–≤</th>
            <th>–í—ã–≤–µ–∑–µ–Ω–æ –ø–∞–∫–µ—Ç–æ–≤</th><th>–í—ã–≤–µ–∑–µ–Ω–æ –∞–Ω–æ–¥–æ–≤</th>
          </tr>
        </thead>
        <tbody id="${id}-tbody"></tbody>
      </table>
    </div>
  `;

  const cam = container.querySelector(".camera");
  const img = cam.querySelector("img");
  cam.addEventListener("click", ()=> openFullscreen(img.src));
  cam.addEventListener("keydown", (e)=> { if(e.key==="Enter"||e.key===" ") openFullscreen(img.src); });
}

const sections = { buffer: "–ë—É—Ñ—Ñ–µ—Ä–Ω —Å–∫–ª–∞–¥ –°–ü–û", south: "–Æ–∂–Ω—ã–π —Å–∫–ª–∞–¥ –∞–Ω–æ–¥–æ–≤ –û–û", north: "–°–µ–≤–µ—Ä–Ω—ã–π —Å–∫–ª–∞–¥ –∞–Ω–æ–¥–æ–≤ –û–û", ready: "–°–∫–ª–∞–¥ –≥–æ—Ç–æ–≤–æ–π –ø—Ä–æ–¥—É–∫—Ü–∏–∏" };
Object.entries(sections).forEach(([id,title])=> createSection(id,title));

document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
    document.getElementById(btn.dataset.section).classList.add("active");
  });
});

async function updateDashboard(){
  const now = new Date();
  const dateStr = fmtDateInTZ(now);
  const timeStr = fmtTimeInTZ(now);
  const hour = getHourInTZ(now);

  Object.keys(sections).forEach(id=>{
    document.getElementById(`${id}-date`).textContent = dateStr;
    document.getElementById(`${id}-time`).textContent = timeStr;
    document.getElementById(`${id}-shift`).textContent = getShiftForHour(hour);
  });

  try{
    const resp = await fetch('api.php', { cache: "no-store" });
    if(!resp.ok) {
      console.error("–û—à–∏–±–∫–∞ API:", resp.status, resp.statusText);
      return;
    }
    const data = await resp.json();

    Object.keys(sections).forEach(id=>{
      const section = data[id] || { trucks:0, in:0, out:0, arrivals:[] };
      // –°–≤–æ–¥–Ω—ã–µ —Ü–∏—Ñ—Ä—ã
      document.getElementById(`${id}-trucks`).textContent = section.trucks ?? 0;
      document.getElementById(`${id}-in`).textContent = `–ø–∞–∫–µ—Ç–æ–≤: ? / –∞–Ω–æ–¥–æ–≤: ${section.in ?? 0}`;
      document.getElementById(`${id}-out`).textContent = `–ø–∞–∫–µ—Ç–æ–≤: ? / –∞–Ω–æ–¥–æ–≤: ${section.out ?? 0}`;

      // –¢–∞–±–ª–∏—Ü–∞ arrivals
      const tbody = document.getElementById(`${id}-tbody`);
      const arrivals = section.arrivals || [];
      if(arrivals.length === 0){
        let rows = "";
        for(let i=1;i<=20;i++){
          rows += `<tr>
            <td>${i}</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td>
          </tr>`;
        }
        tbody.innerHTML = rows;
      } else {
        let rows = "";
        arrivals.forEach((a, idx) => {
          let arrivedDisplay = '‚Äî';
          if (a.arrived_at) {
            // —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è (—É–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã, ISO)
            const d = new Date(a.arrived_at.replace(' ', 'T'));
            arrivedDisplay = `${fmtDateInTZ(d)} ${fmtTimeInTZ(d)}<div class="muted">${a.state_number || ''}</div>`;
          } else {
            arrivedDisplay = a.state_number ? `<div class="muted">${a.state_number}</div>` : '‚Äî';
          }

          let departedDisplay = '‚Äî';
          if (a.departed_at && a.departed_at !== 'NULL') {
            const d2 = new Date(a.departed_at.replace(' ', 'T'));
            departedDisplay = `${fmtDateInTZ(d2)} ${fmtTimeInTZ(d2)}`;
          }

          let photoCell = '‚Äî';
          if (a.arrived_photo) {
            photoCell = `<img class="tiny" src="${a.arrived_photo}" alt="in" onclick="openFullscreen(this.src)">`;
          } else {
            photoCell = 'üì∑';
          }

          const in_packages = a.packages_count ?? 0;
          const in_blocks = a.blocks_sum ?? 0;
          const out_packages = (a.departed_at && a.departed_at !== 'NULL') ? in_packages : 0;
          const out_blocks = (a.departed_at && a.departed_at !== 'NULL') ? in_blocks : 0;

          rows += `<tr>
            <td>${idx+1}</td>
            <td class="left">${arrivedDisplay}</td>
            <td>${photoCell}</td>
            <td class="left">${departedDisplay}</td>
            <td>${in_packages}</td>
            <td>${in_blocks}</td>
            <td>${out_packages}</td>
            <td>${out_blocks}</td>
          </tr>`;
        });
        tbody.innerHTML = rows;
      }
    });

  } catch(e){
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:", e);
  }
}

updateDashboard();
setInterval(updateDashboard, 2000);

function flash(msg, ms=2500){
  let el = document.createElement("div");
  el.textContent = msg;
  el.style.position="fixed"; el.style.left="50%"; el.style.bottom="22px"; el.style.transform="translateX(-50%)";
  el.style.background="#111"; el.style.color="#fff"; el.style.padding="10px 14px"; el.style.borderRadius="8px"; el.style.zIndex=10000;
  document.body.appendChild(el); setTimeout(()=>el.remove(), ms);
}

flash("–í—Ä–µ–º—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø–æ –ú–æ—Å–∫–æ–≤—Å–∫–æ–º—É —á–∞—Å–æ–≤–æ–º—É –ø–æ—è—Å—É (MSK).");

(function addKeyboardNav(){
  const tabs = Array.from(document.querySelectorAll(".tab-btn"));
  tabs.forEach((t,i)=> t.addEventListener("keydown",(e)=>{
    if(e.key==="ArrowRight"){ tabs[(i+1)%tabs.length].focus();}
    if(e.key==="ArrowLeft"){ tabs[(i-1+tabs.length)%tabs.length].focus();}
  }));
})();
</script>
</body>
</html>
```
