<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Äî –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (—á/–±)</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body.settings-page {
      background: var(--bg);
    }
    .settings-page header {
      display: flex;
      gap: 6px;
      align-items: center;
      padding: 10px;
      background: #222;
      color: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .settings-page .tab-btn {
      background: transparent;
      color: #fff;
      border: 1px solid rgba(255,255,255,0.06);
      padding: 12px 18px;
      cursor: pointer;
      border-radius: 8px;
      transition: all 180ms ease;
      font-weight: 600;
      font-size: 1.05rem;
    }
    .settings-page .tab-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.35); }
    .settings-page .tab-btn.active { background: #555; }
    .settings-page .back-btn {
      background: transparent;
      color: #fff;
      border: 1px solid rgba(255,255,255,0.2);
      padding: 8px 14px;
      cursor: pointer;
      border-radius: 6px;
      font-weight: 600;
      transition: all 180ms ease;
      margin-right: auto;
    }
    .settings-page .back-btn:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
    .settings-page main {
      padding: 20px;
      max-width: 1200px;
      margin: 16px auto;
    }
    .settings-page .section {
      display: none;
      gap: 18px;
      flex-wrap: wrap;
    }
    .settings-page .section.active {
      display: flex;
    }
    .settings-page .camera {
      width: 100%;
      min-width: 280px;
      height: 220px;
      background: var(--muted);
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      overflow: hidden;
      border-radius: 8px;
      border: 2px solid rgba(0,0,0,0.07);
      box-shadow: 0 6px 18px rgba(0,0,0,0.12) inset;
    }
    .settings-page .camera img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
  </style>
</head>
<body class="settings-page">
<header>
  <button class="tab-btn active" data-section="buffer">–ë—É—Ñ—Ñ–µ—Ä–Ω —Å–∫–ª–∞–¥ –°–ü–û</button>
  <button class="tab-btn" data-section="south">–Æ–∂–Ω—ã–π —Å–∫–ª–∞–¥ –∞–Ω–æ–¥–æ–≤ –û–û</button>
  <button class="tab-btn" data-section="north">–°–µ–≤–µ—Ä–Ω—ã–π —Å–∫–ª–∞–¥ –∞–Ω–æ–¥–æ–≤ –û–û</button>
  <button class="tab-btn" data-section="ready">–°–∫–ª–∞–¥ –≥–æ—Ç–æ–≤–æ–π –ø—Ä–æ–¥—É–∫—Ü–∏–∏</button>
  <div style="flex:1"></div>
  <button class="back-btn" id="back-btn">–ù–∞–∑–∞–¥ ‚Üí</button>
</header>

<main>
  <div class="settings-main" style="display:flex;gap:18px;max-width:1200px;margin:16px auto;">
    <div class="preview-column" style="flex:1;min-width:280px;">
      <div class="camera" tabindex="0" aria-label="–ü—Ä–µ–≤—å—é –∫–∞–º–µ—Ä—ã">
        <img id="preview-img" src="1.jpg" alt="–ü—Ä–µ–≤—å—é">
      </div>
      <div class="cameras-list" id="preview-cameras" style="margin-top:14px;"></div>
    </div>

    <aside class="right-panel" style="width:320px;">
      <div style="background:#fff;border-radius:8px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.04);">
        <strong style="display:block;margin-bottom:10px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</strong>
        <div id="right-sections" style="display:flex;flex-direction:column;gap:8px;"></div>
      </div>
    </aside>
  </div>
</main>

<div id="fullscreen" class="fullscreen" aria-hidden="true">
  <span class="close-btn" role="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">&times;</span>
  <img src="" alt="Full Image">
</div>

<script>
// --- Cameras editing support (define early) ---
const SECTION_TO_WAREHOUSE = { buffer: 1, south: 2, north: 3, ready: 4 };
const WAREHOUSE_NAMES = { 1: '–ë—É—Ñ—Ñ–µ—Ä–Ω —Å–∫–ª–∞–¥ –°–ü–û', 2: '–Æ–∂–Ω—ã–π —Å–∫–ª–∞–¥ –∞–Ω–æ–¥–æ–≤ –û–û', 3: '–°–µ–≤–µ—Ä–Ω—ã–π —Å–∫–ª–∞–¥ –∞–Ω–æ–¥–æ–≤ –û–û', 4: '–°–∫–ª–∞–¥ –≥–æ—Ç–æ–≤–æ–π –ø—Ä–æ–¥—É–∫—Ü–∏–∏' };
let CAMERA_TYPES = [];
let CURRENT_WAREHOUSE_ID = 1;

function sectionImageFor(id){
  const map = { buffer: '1.jpg', south: '2.jpg', north: '3.jpg', ready: '4.jpg' };
  return map[id] || '1.jpg';
}

async function fetchCameraTypes(){
  try{
    const resp = await fetch('cameras_api.php?types=1', { cache: 'no-store' });
    if(!resp.ok) return [];
    const data = await resp.json();
    CAMERA_TYPES = data.types || [];
    return CAMERA_TYPES;
  }catch(e){ console.error('types load error', e); return []; }
}

async function loadCamerasForWarehouse(wid, sectionId){
  const container = document.getElementById('preview-cameras');
  if(!container) return;
  container.innerHTML = '<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–º–µ—Ä...</div>';
  await fetchCameraTypes();
  CURRENT_WAREHOUSE_ID = wid;
  // update preview image
  const pi = document.getElementById('preview-img'); if(pi) pi.src = sectionImageFor(sectionId);
  try{
    const resp = await fetch('cameras_api.php?warehouse_id=' + encodeURIComponent(wid), { cache: 'no-store' });
    if(!resp.ok){ container.innerHTML = '<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; return; }
    const data = await resp.json();
    const cams = data.cameras || [];
    container.innerHTML = '';
    if(cams.length === 0){ container.innerHTML = '<div class="muted">–ö–∞–º–µ—Ä—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–ª—è —ç—Ç–æ–≥–æ —Å–∫–ª–∞–¥–∞</div>'; return; }
    cams.forEach(cam => renderCameraForm(container, cam));
  }catch(e){ console.error(e); container.innerHTML = '<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; }
}

// Fade in on page load with minimal animation
window.addEventListener('load', ()=>{
  document.body.style.opacity = '1';
  document.body.style.transition = 'opacity 150ms ease';
});
document.body.style.opacity = '0';

// Restore preview image from sessionStorage but DO NOT auto-load forms
const savedSection = sessionStorage.getItem('currentSection') || 'buffer';
const previewImg = document.getElementById('preview-img');
if(previewImg){
  previewImg.src = sectionImageFor(savedSection);
}

function renderCameraForm(container, cam){
  const div = document.createElement('div');
  div.className = 'camera-form';
  // parse existing ip_camera into host, login, password
  function parseRtsp(url){
    if(!url) return {host:'', login:'', password:''};
    try{
      // remove surrounding whitespace
      let s = String(url).trim();
      // Remove /live from the end if present
      s = s.replace(/\/live$/i, '');
      // make sure scheme exists for parsing
      if(!/^\w+:\/\//.test(s)) s = 'rtsp://' + s;
      // regex: scheme://[user:pass@]host/path
      const m = s.match(/^(\w+:\/\/)(?:([^:@\/]+)(?::([^@\/]+))?@)?(.+)$/);
      if(!m) return {host: s, login:'', password:''};
      return {host: m[4], login: m[2]||'', password: m[3]||''};
    }catch(e){ return {host: url, login:'', password:''}; }
  }

  const parsed = parseRtsp(cam.ip_camera || '');

  div.innerHTML = `
    <div class="row"><div><strong>–ö–∞–º–µ—Ä–∞ #${cam.id}</strong></div></div>
    <div class="row"><div>IP/Host</div><div><input type="text" class="ip-input" value="${parsed.host||''}" style="width:100%" disabled></div></div>
    <div class="row"><div>–õ–æ–≥–∏–Ω</div><div><input type="text" class="login-input" value="${parsed.login||''}" style="width:100%" disabled></div></div>
    <div class="row"><div>–ü–∞—Ä–æ–ª—å</div><div><input type="password" class="pass-input" value="${parsed.password||''}" style="width:100%" disabled></div></div>
    <div class="row"><div>–¢–∏–ø</div><div><select class="type-select" style="width:100%" disabled></select></div></div>
    <div class="row"><div></div><div><button class="edit-camera" data-mode="view">–ò–∑–º–µ–Ω–∏—Ç—å</button></div></div>
  `;

  // populate types
  const sel = div.querySelector('.type-select');
  CAMERA_TYPES.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t.id;
    opt.textContent = (t.description && t.description.length) ? t.description : ('–¢–∏–ø #' + t.id);
    if (cam.camera_type_id && Number(cam.camera_type_id) === Number(t.id)) opt.selected = true;
    sel.appendChild(opt);
  });

  // edit/save toggle
  const editBtn = div.querySelector('.edit-camera');
  const ipInput = div.querySelector('.ip-input');
  const loginInput = div.querySelector('.login-input');
  const passInput = div.querySelector('.pass-input');
  ipInput.disabled = true;
  loginInput.disabled = true;
  passInput.disabled = true;
  sel.disabled = true;

  editBtn.addEventListener('click', async ()=>{
    if (editBtn.dataset.mode === 'view') {
      // switch to edit mode
      editBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
      editBtn.dataset.mode = 'edit';
      ipInput.disabled = false;
      loginInput.disabled = false;
      passInput.disabled = false;
      sel.disabled = false;
      ipInput.focus();
      return;
    }

    // save mode ‚Äî build RTSP URL from fields and send as ip_camera
    const hostPart = ipInput.value.trim();
    const login = loginInput.value.trim();
    const pass = passInput.value;
    const typeId = sel.value;

    if(!hostPart){ flash('IP/Host –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'); return; }

    // normalize hostPart (remove scheme and credentials if present)
    let hp = hostPart.replace(/^\s+|\s+$/g, '');
    hp = hp.replace(/^\w+:\/\//,'');
    hp = hp.replace(/^[^@]+@/,'');
    // build full url with /live at the end
    const full = 'rtsp://' + (login ? (encodeURIComponent(login) + (pass ? ':' + encodeURIComponent(pass) : '') + '@') : '') + hp + '/live';

    try{
      const resp = await fetch('cameras_api.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: cam.id, ip_camera: full, camera_type_id: typeId })
      });
      if(!resp.ok) { flash('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã'); return; }
      const r = await resp.json();
      if(r.ok){
        flash('–ö–∞–º–µ—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
        // return to view mode
        editBtn.textContent = '–ò–∑–º–µ–Ω–∏—Ç—å';
        editBtn.dataset.mode = 'view';
        ipInput.disabled = true;
        loginInput.disabled = true;
        passInput.disabled = true;
        sel.disabled = true;
        // refresh list
        loadCamerasForSection(container.dataset.section);
      } else {
        flash('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ—É—Å–ø–µ—à–Ω–æ');
      }
    }catch(e){ console.error(e); flash('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
  });

  container.appendChild(div);
}

async function loadCamerasForWarehouse(wid, sectionId){
  const container = document.getElementById('preview-cameras');
  if(!container) return;
  container.innerHTML = '<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–º–µ—Ä...</div>';
  await fetchCameraTypes();
  CURRENT_WAREHOUSE_ID = wid;
  // update preview image
  const pi = document.getElementById('preview-img'); if(pi) pi.src = sectionImageFor(sectionId);
  try{
    const resp = await fetch('cameras_api.php?warehouse_id=' + encodeURIComponent(wid), { cache: 'no-store' });
    if(!resp.ok){ container.innerHTML = '<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; return; }
    const data = await resp.json();
    const cams = data.cameras || [];
    container.innerHTML = '';
    if(cams.length === 0){ container.innerHTML = '<div class="muted">–ö–∞–º–µ—Ä—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–ª—è —ç—Ç–æ–≥–æ —Å–∫–ª–∞–¥–∞</div>'; return; }
    cams.forEach(cam => renderCameraForm(container, cam));
  }catch(e){ console.error(e); container.innerHTML = '<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; }
}

async function loadCamerasForSection(sectionId){
  const container = document.getElementById('preview-cameras');
  if(!container) return;
  container.innerHTML = '<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–º–µ—Ä...</div>';
  await fetchCameraTypes();
  const wid = SECTION_TO_WAREHOUSE[sectionId];
  // update preview image
  const pi = document.getElementById('preview-img'); if(pi) pi.src = sectionImageFor(sectionId);
  try{
    const resp = await fetch('cameras_api.php?warehouse_id=' + encodeURIComponent(wid), { cache: 'no-store' });
    if(!resp.ok){ container.innerHTML = '<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; return; }
    const data = await resp.json();
    const cams = data.cameras || [];
    container.innerHTML = '';
    if(cams.length === 0){ container.innerHTML = '<div class="muted">–ö–∞–º–µ—Ä—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–ª—è —ç—Ç–æ–≥–æ —Å–∫–ª–∞–¥–∞</div>'; container.dataset.section = sectionId; return; }
    // store section id for reload
    container.dataset.section = sectionId;
    cams.forEach(cam => renderCameraForm(container, cam));
  }catch(e){ console.error(e); container.innerHTML = '<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; }
}

async function loadAllCameras(){
  const container = document.getElementById('preview-cameras');
  if(!container) return;
  container.innerHTML = '<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–º–µ—Ä...</div>';
  await fetchCameraTypes();
  container.innerHTML = '';
  
  try{
    for(const [sectionId, wid] of Object.entries(SECTION_TO_WAREHOUSE)) {
      const resp = await fetch('cameras_api.php?warehouse_id=' + encodeURIComponent(wid), { cache: 'no-store' });
      if(!resp.ok) continue;
      const data = await resp.json();
      const cams = data.cameras || [];
      
      if(cams.length > 0) {
        // Add warehouse section header
        const header = document.createElement('div');
        header.style.marginTop = '14px';
        header.style.marginBottom = '8px';
        header.innerHTML = `<strong style="color:#666;font-size:0.95rem;">${WAREHOUSE_NAMES[wid] || '–°–∫–ª–∞–¥ ' + wid}</strong>`;
        container.appendChild(header);
        
        cams.forEach(cam => renderCameraForm(container, cam));
      }
    }
    
    if(container.children.length === 0) {
      container.innerHTML = '<div class="muted">–ö–∞–º–µ—Ä—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã</div>';
    }
  }catch(e){ console.error(e); container.innerHTML = '<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; }
}

// Back button ‚Äî save current section and navigate to index with fade
document.getElementById('back-btn').addEventListener('click', ()=>{
  // Save the currently active section and navigate back with explicit param
  const activeSection = document.querySelector('header button.tab-btn.active');
  const sectionId = activeSection ? activeSection.dataset.section : (sessionStorage.getItem('currentSection') || 'buffer');
  // Also keep sessionStorage in sync
  sessionStorage.setItem('currentSection', sectionId);
  document.body.style.opacity = '0';
  document.body.style.transition = 'opacity 200ms ease';
  setTimeout(()=> { window.location.href = 'index.html'; }, 200);
});

// header tab switching for warehouses ‚Äî load cameras for selected warehouse
document.querySelectorAll('header .tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('header .tab-btn').forEach(b=> b.classList.remove('active'));
    btn.classList.add('active');
    // change preview image
    const sec = btn.dataset.section;
    const pi = document.getElementById('preview-img');
    if(pi) pi.src = sectionImageFor(sec);
    // save selection so when opening settings from main it stays consistent
    sessionStorage.setItem('currentSection', sec);
    // Load cameras for this warehouse when clicking a warehouse tab
    const wid = SECTION_TO_WAREHOUSE[sec];
    loadCamerasForWarehouse(wid, sec);
  });
});

document.addEventListener('DOMContentLoaded', ()=>{
  const right = document.getElementById('right-sections');
  // Build right panel with components (only Cameras for now)
  const components = [
    { id: 'cameras', label: 'üé• –ö–∞–º–µ—Ä—ã', icon: 'üì∑' }
  ];
  
  components.forEach(comp => {
    const btn = document.createElement('button');
    btn.className = 'tab-btn';
    if(comp.id === 'cameras') btn.classList.add('active');
    btn.style.textAlign = 'left';
    btn.style.fontSize = '1rem';
    btn.textContent = comp.label;
    btn.dataset.component = comp.id;
    btn.addEventListener('click', ()=>{
      // mark active in right panel
      right.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      // For now only cameras, so just ensure cameras are loaded for current warehouse
      const activeWarehouse = document.querySelector('header .tab-btn.active');
      if(activeWarehouse) {
        const wid = SECTION_TO_WAREHOUSE[activeWarehouse.dataset.section];
        loadCamerasForWarehouse(wid, activeWarehouse.dataset.section);
      }
    });
    right.appendChild(btn);
  });
  
  // Load cameras for saved section on page load
  const savedSection = sessionStorage.getItem('currentSection') || 'buffer';
  const wid = SECTION_TO_WAREHOUSE[savedSection];
  loadCamerasForWarehouse(wid, savedSection);
});

// simple notifier
function flash(msg){ alert(msg); }

// Fullscreen for images
function openFullscreen(src){
  const fs = document.getElementById('fullscreen');
  fs.style.display='flex'; fs.setAttribute('aria-hidden','false');
  fs.querySelector('img').src = src;
}
document.querySelector('.close-btn').addEventListener('click', ()=>{ 
  const fs = document.getElementById('fullscreen'); 
  fs.style.display='none'; 
  fs.setAttribute('aria-hidden','true'); 
});
document.getElementById('fullscreen').addEventListener('click',(e)=>{ 
  if(e.target.id==='fullscreen') { 
    e.currentTarget.style.display='none'; 
    e.currentTarget.setAttribute('aria-hidden','true'); 
  } 
});

// Click/keyboard on camera
document.querySelectorAll('.camera').forEach(cam=>{
  const img = cam.querySelector('img');
  cam.addEventListener('click', ()=> openFullscreen(img.src));
  cam.addEventListener('keydown', (e)=> { 
    if(e.key==='Enter'||e.key===' ') openFullscreen(img.src); 
  });
});
</script>
</body>
</html>
