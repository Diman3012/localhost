<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Настройки — Мониторинг (ч/б)</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body.settings-page {
      background: var(--bg);
    }
    .settings-page header {
      display: flex;
      gap: 6px;
      align-items: center;
      padding: 10px;
      background: #222;
      color: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .settings-page .tab-btn {
      background: transparent;
      color: #fff;
      border: 1px solid rgba(255,255,255,0.06);
      padding: 10px 16px;
      cursor: pointer;
      border-radius: 8px;
      transition: all 180ms ease;
      font-weight: 600;
    }
    .settings-page .tab-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.35); }
    .settings-page .tab-btn.active { background: #555; }
    .settings-page .back-btn {
      background: transparent;
      color: #fff;
      border: 1px solid rgba(255,255,255,0.2);
      padding: 8px 14px;
      cursor: pointer;
      border-radius: 6px;
      font-weight: 600;
      transition: all 180ms ease;
      margin-right: auto;
    }
    .settings-page .back-btn:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
    .settings-page main {
      padding: 20px;
      max-width: 1200px;
      margin: 16px auto;
    }
    .settings-page .section {
      display: none;
      gap: 18px;
      flex-wrap: wrap;
    }
    .settings-page .section.active {
      display: flex;
    }
    .settings-page .camera {
      width: 420px;
      min-width: 280px;
      height: 320px;
      background: var(--muted);
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      overflow: hidden;
      border-radius: 8px;
      border: 2px solid rgba(0,0,0,0.07);
      box-shadow: 0 6px 18px rgba(0,0,0,0.12) inset;
    }
    .settings-page .camera img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
  </style>
</head>
<body class="settings-page">
<header>
  <button class="tab-btn active" data-section="buffer">Буфферн склад СПО</button>
  <button class="tab-btn" data-section="south">Южный склад анодов ОО</button>
  <button class="tab-btn" data-section="north">Северный склад анодов ОО</button>
  <button class="tab-btn" data-section="ready">Склад готовой продукции</button>
  <div style="flex:1"></div>
  <button class="back-btn" id="back-btn">Назад →</button>
</header>

<main>
  <section id="buffer" class="section active">
    <div class="camera" tabindex="0" aria-label="Камера Буфферн склад СПО">
      <img src="1.jpg" alt="Камера Буфферн склад СПО">
    </div>
    <div class="cameras-list" id="buffer-cameras"></div>
  </section>
  <section id="south" class="section">
    <div class="camera" tabindex="0" aria-label="Камера Южный склад анодов ОО">
      <img src="2.jpg" alt="Камера Южный склад анодов ОО">
    </div>
    <div class="cameras-list" id="south-cameras"></div>
  </section>
  <section id="north" class="section">
    <div class="camera" tabindex="0" aria-label="Камера Северный склад анодов ОО">
      <img src="3.jpg" alt="Камера Северный склад анодов ОО">
    </div>
    <div class="cameras-list" id="north-cameras"></div>
  </section>
  <section id="ready" class="section">
    <div class="camera" tabindex="0" aria-label="Камера Склад готовой продукции">
      <img src="4.jpg" alt="Камера Склад готовой продукции">
    </div>
    <div class="cameras-list" id="ready-cameras"></div>
  </section>
</main>

<div id="fullscreen" class="fullscreen" aria-hidden="true">
  <span class="close-btn" role="button" aria-label="Закрыть">&times;</span>
  <img src="" alt="Full Image">
</div>

<script>
// Fade in on page load with minimal animation
window.addEventListener('load', ()=>{
  document.body.style.opacity = '1';
  document.body.style.transition = 'opacity 150ms ease';
});
document.body.style.opacity = '0';

// Restore section from sessionStorage
const savedSection = sessionStorage.getItem('currentSection') || 'buffer';
const tabToActivate = document.querySelector(`[data-section="${savedSection}"]`);
if(tabToActivate) {
  document.querySelectorAll('.tab-btn').forEach(b=> b.classList.remove('active'));
  tabToActivate.classList.add('active');
  document.querySelectorAll('.section').forEach(s=> s.classList.remove('active'));
  document.getElementById(savedSection).classList.add('active');
}

// Back button — save current section and navigate to index with fade
document.getElementById('back-btn').addEventListener('click', ()=>{
  // Save the currently active section and navigate back with explicit param
  const activeSection = document.querySelector('.section.active');
  const sectionId = activeSection ? activeSection.id : (sessionStorage.getItem('currentSection') || 'buffer');
  // Also keep sessionStorage in sync
  sessionStorage.setItem('currentSection', sectionId);
  document.body.style.opacity = '0';
  document.body.style.transition = 'opacity 200ms ease';
  setTimeout(()=> { window.location.href = 'index.html'; }, 200);
});

// Tab switching - also save section
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab-btn').forEach(b=> b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.section').forEach(s=> s.classList.remove('active'));
    document.getElementById(btn.dataset.section).classList.add('active');
    // Save current section to sessionStorage
    sessionStorage.setItem('currentSection', btn.dataset.section);
    // Load cameras for this section
    loadCamerasForSection(btn.dataset.section);
  });
});

// --- Cameras editing support ---
const SECTION_TO_WAREHOUSE = { buffer: 1, south: 2, north: 3, ready: 4 };
let CAMERA_TYPES = [];

async function fetchCameraTypes(){
  try{
    const resp = await fetch('cameras_api.php?types=1', { cache: 'no-store' });
    if(!resp.ok) return [];
    const data = await resp.json();
    CAMERA_TYPES = data.types || [];
    return CAMERA_TYPES;
  }catch(e){ console.error('types load error', e); return []; }
}

function renderCameraForm(container, cam){
  const div = document.createElement('div');
  div.className = 'camera-form';
  div.innerHTML = `
    <div class="row"><div><strong>Камера #${cam.id}</strong></div></div>
    <div class="row"><div>IP/URL</div><div><input type="text" class="ip-input" value="${cam.ip_camera || ''}" style="width:100%" disabled></div></div>
    <div class="row"><div>Тип</div><div><select class="type-select" style="width:100%" disabled></select></div></div>
    <div class="row"><div></div><div><button class="edit-camera" data-mode="view">Изменить</button></div></div>
  `;

  // populate types
  const sel = div.querySelector('.type-select');
  CAMERA_TYPES.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t.id;
    opt.textContent = (t.description && t.description.length) ? t.description : ('Тип #' + t.id);
    if (cam.camera_type_id && Number(cam.camera_type_id) === Number(t.id)) opt.selected = true;
    sel.appendChild(opt);
  });

  // edit/save toggle
  const editBtn = div.querySelector('.edit-camera');
  const ipInput = div.querySelector('.ip-input');
  ipInput.disabled = true;
  sel.disabled = true;

  editBtn.addEventListener('click', async ()=>{
    if (editBtn.dataset.mode === 'view') {
      // switch to edit mode
      editBtn.textContent = 'Сохранить';
      editBtn.dataset.mode = 'edit';
      ipInput.disabled = false;
      sel.disabled = false;
      ipInput.focus();
      return;
    }

    // save mode
    const ip = ipInput.value.trim();
    const typeId = sel.value;
    try{
      const resp = await fetch('cameras_api.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: cam.id, ip_camera: ip, camera_type_id: typeId })
      });
      if(!resp.ok) { flash('Ошибка сохранения камеры'); return; }
      const r = await resp.json();
      if(r.ok){
        flash('Камера сохранена');
        // return to view mode
        editBtn.textContent = 'Изменить';
        editBtn.dataset.mode = 'view';
        ipInput.disabled = true;
        sel.disabled = true;
        // refresh list
        loadCamerasForSection(container.dataset.section);
      } else {
        flash('Сохранение неуспешно');
      }
    }catch(e){ console.error(e); flash('Ошибка сети'); }
  });

  container.appendChild(div);
}

async function loadCamerasForSection(sectionId){
  const container = document.getElementById(sectionId + '-cameras');
  if(!container) return;
  container.innerHTML = '<div class="muted">Загрузка камер...</div>';
  await fetchCameraTypes();
  const wid = SECTION_TO_WAREHOUSE[sectionId];
  try{
    const resp = await fetch('cameras_api.php?warehouse_id=' + encodeURIComponent(wid), { cache: 'no-store' });
    if(!resp.ok){ container.innerHTML = '<div class="muted">Ошибка загрузки</div>'; return; }
    const data = await resp.json();
    const cams = data.cameras || [];
    container.innerHTML = '';
    if(cams.length === 0){ container.innerHTML = '<div class="muted">Камеры не настроены для этого склада</div>'; return; }
    // store section id for reload
    container.dataset.section = sectionId;
    cams.forEach(cam => renderCameraForm(container, cam));
  }catch(e){ console.error(e); container.innerHTML = '<div class="muted">Ошибка загрузки</div>'; }
}

// on initial load, load cameras for saved section
document.addEventListener('DOMContentLoaded', ()=>{
  const cur = sessionStorage.getItem('currentSection') || 'buffer';
  loadCamerasForSection(cur);
});

// simple notifier
function flash(msg){ alert(msg); }

// Fullscreen for images
function openFullscreen(src){
  const fs = document.getElementById('fullscreen');
  fs.style.display='flex'; fs.setAttribute('aria-hidden','false');
  fs.querySelector('img').src = src;
}
document.querySelector('.close-btn').addEventListener('click', ()=>{ 
  const fs = document.getElementById('fullscreen'); 
  fs.style.display='none'; 
  fs.setAttribute('aria-hidden','true'); 
});
document.getElementById('fullscreen').addEventListener('click',(e)=>{ 
  if(e.target.id==='fullscreen') { 
    e.currentTarget.style.display='none'; 
    e.currentTarget.setAttribute('aria-hidden','true'); 
  } 
});

// Click/keyboard on camera
document.querySelectorAll('.camera').forEach(cam=>{
  const img = cam.querySelector('img');
  cam.addEventListener('click', ()=> openFullscreen(img.src));
  cam.addEventListener('keydown', (e)=> { 
    if(e.key==='Enter'||e.key===' ') openFullscreen(img.src); 
  });
});
</script>
</body>
</html>
