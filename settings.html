<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Äî –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (—á/–±)</title>
  <link rel="stylesheet" href="style.css?v=2">
  <style>
    body.settings-page {
      background: var(--bg);
    }
    .settings-page header {
      display: flex;
      gap: 6px;
      align-items: center;
      padding: 10px;
      background: #222;
      color: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .settings-page .back-btn {
      background: transparent;
      color: #fff;
      border: 1px solid rgba(255,255,255,0.2);
      padding: 10px 16px;
      cursor: pointer;
      border-radius: 8px;
      font-weight: 600;
      transition: color 180ms ease;
      margin-right: auto;
    }
    .settings-page .back-btn:hover { 
      color: #aaa;
    }
  </style>
</head>
<body class="settings-page">
<header>
  <button class="tab-btn active" data-section="buffer">–ë—É—Ñ—Ñ–µ—Ä–Ω —Å–∫–ª–∞–¥ –°–ü–û</button>
  <button class="tab-btn" data-section="south">–Æ–∂–Ω—ã–π —Å–∫–ª–∞–¥ –∞–Ω–æ–¥–æ–≤ –û–û</button>
  <button class="tab-btn" data-section="north">–°–µ–≤–µ—Ä–Ω—ã–π —Å–∫–ª–∞–¥ –∞–Ω–æ–¥–æ–≤ –û–û</button>
  <button class="tab-btn" data-section="ready">–°–∫–ª–∞–¥ –≥–æ—Ç–æ–≤–æ–π –ø—Ä–æ–¥—É–∫—Ü–∏–∏</button>
  <div style="flex:1"></div>
  <button class="back-btn" id="back-btn">–ù–∞–∑–∞–¥ ‚Üí</button>
</header>

<main class="container">
  <div class="settings-main">
    <div class="preview-column">
      <div class="camera" tabindex="0" aria-label="–ü—Ä–µ–≤—å—é –∫–∞–º–µ—Ä—ã">
        <img id="preview-img" src="1.jpg" alt="–ü—Ä–µ–≤—å—é">
      </div>
      <div class="cameras-list" id="preview-cameras" style="margin-top:14px;"></div>
    </div>

    <aside class="right-panel">
      <div class="right-box">
        <strong style="display:block;margin-bottom:10px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</strong>
        <div id="right-sections" style="display:flex;flex-direction:column;gap:8px;"></div>
      </div>
    </aside>
  </div>
</main>

<div id="fullscreen" class="fullscreen" aria-hidden="true">
  <span class="close-btn" role="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">&times;</span>
  <img src="" alt="Full Image">
</div>

<script>
// --- Cameras editing support (define early) ---
const SECTION_TO_WAREHOUSE = { buffer: 1, south: 2, north: 3, ready: 4 };
const WAREHOUSE_TO_SECTION = { 1: 'buffer', 2: 'south', 3: 'north', 4: 'ready' };
let WAREHOUSE_NAMES = { 1: '–ë—É—Ñ—Ñ–µ—Ä–Ω —Å–∫–ª–∞–¥ –°–ü–û', 2: '–Æ–∂–Ω—ã–π —Å–∫–ª–∞–¥ –∞–Ω–æ–¥–æ–≤ –û–û', 3: '–°–µ–≤–µ—Ä–Ω—ã–π —Å–∫–ª–∞–¥ –∞–Ω–æ–¥–æ–≤ –û–û', 4: '–°–∫–ª–∞–¥ –≥–æ—Ç–æ–≤–æ–π –ø—Ä–æ–¥—É–∫—Ü–∏–∏' };
let CAMERA_TYPES = [];
let CURRENT_WAREHOUSE_ID = 1;
let allWarehouses = []; // –í—Å–µ —Å–∫–ª–∞–¥—ã –∏–∑ –ë–î

// –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è —Å–∫–ª–∞–¥–æ–≤ –∏–∑ –ë–î –∏ –ø—ã—Ç–∞–µ–º—Å—è —Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å –∏—Ö —Å —Ä–∞–∑–¥–µ–ª–∞–º–∏
async function loadWarehouseNames(){
  try{
    const resp = await fetch('warehouses_api.php', { cache: 'no-store' });
    if(!resp.ok) return;
    const data = await resp.json();
    allWarehouses = data.warehouses || [];

    // –ò–Ω–¥–µ–∫—Å –ø–æ id
    const byId = {};
    allWarehouses.forEach(w => { byId[w.id] = w; });

    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –∏–º–µ–Ω–∞ –≤ –æ–±—ä–µ–∫—Ç–µ
    allWarehouses.forEach(wh => { WAREHOUSE_NAMES[wh.id] = wh.name; });

    // –ü–æ–ø—Ä–æ–±—É–µ–º —Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª—ã (buffer, south, north, ready) –ø–æ id, type –∏–ª–∏ –∏–º–µ–Ω–∏
    const assignForSection = (sectionKey, matcher) => {
      const currentId = SECTION_TO_WAREHOUSE[sectionKey];
      if (byId[currentId]) return; // —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω–æ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É id
      const found = allWarehouses.find(matcher);
      if (found) {
        SECTION_TO_WAREHOUSE[sectionKey] = found.id; // –æ–±–Ω–æ–≤–ª—è–µ–º –º–∞–ø–ø–∏–Ω–≥
        WAREHOUSE_NAMES[found.id] = found.name;
      }
    };

    // buffer: –∏—â–µ–º –ø–æ type/name —Å–æ–¥–µ—Ä–∂–∞—â–µ–º—É "–±—É—Ñ–µ—Ä"
    assignForSection('buffer', w => (w.type||'').toLowerCase().includes('–±—É—Ñ–µ—Ä') || (w.name||'').toLowerCase().includes('–±—É—Ñ–µ—Ä'));
    // ready: –∏—â–µ–º –ø–æ type/name —Å–æ–¥–µ—Ä–∂–∞—â–µ–º—É "–≥–æ—Ç–æ–≤"
    assignForSection('ready', w => (w.type||'').toLowerCase().includes('–≥–æ—Ç–æ–≤') || (w.name||'').toLowerCase().includes('–≥–æ—Ç–æ–≤'));
    // south/north: —Å—Ç–∞—Ä–∞–µ–º—Å—è –∏—Å–∫–∞—Ç—å —è–≤–Ω—ã–µ —Å–ª–æ–≤–∞ "—é–∂" –∏ "—Å–µ–≤"
    assignForSection('south', w => (w.name||'').toLowerCase().includes('—é–∂'));
    assignForSection('north', w => (w.name||'').toLowerCase().includes('—Å–µ–≤'));

    // –ï—Å–ª–∏ –¥–ª—è —é–≥–∞/—Å–µ–≤–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —è–≤–Ω—ã—Ö —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π, –ø–æ–ø—Ä–æ–±—É–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ —Ç–∏–ø—É "–∞–Ω–æ–¥—ã"
    const anodes = allWarehouses.filter(w => (w.type||'').toLowerCase().includes('–∞–Ω–æ–¥') || (w.name||'').toLowerCase().includes('–∞–Ω–æ–¥'));
    if (!byId[SECTION_TO_WAREHOUSE['south']] && anodes[0]) {
      SECTION_TO_WAREHOUSE['south'] = anodes[0].id;
      WAREHOUSE_NAMES[anodes[0].id] = anodes[0].name;
    }
    if (!byId[SECTION_TO_WAREHOUSE['north']] && anodes[1]) {
      SECTION_TO_WAREHOUSE['north'] = anodes[1].id;
      WAREHOUSE_NAMES[anodes[1].id] = anodes[1].name;
    }

    // –ù–∞–∫–æ–Ω–µ—Ü –æ–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ header
    updateHeaderButtons();
  }catch(e){ console.error('Error loading warehouse names:', e); }
}

function updateHeaderButtons(){
  const header = document.querySelector('header');
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–Ω–æ–ø–æ–∫
  Object.entries(SECTION_TO_WAREHOUSE).forEach(([section, whId]) => {
    const btn = header.querySelector(`[data-section="${section}"]`);
    if(btn && WAREHOUSE_NAMES[whId]){
      btn.textContent = WAREHOUSE_NAMES[whId];
    }
  });
  
  // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Å–∫–ª–∞–¥–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –Ω–∏ –∫ –æ–¥–Ω–æ–º—É —Ä–∞–∑–¥–µ–ª—É
  allWarehouses.forEach(wh => {
    if (!WAREHOUSE_TO_SECTION[wh.id]) {
      // –≠—Ç–æ—Ç —Å–∫–ª–∞–¥ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –Ω–∏ –∫ –æ–¥–Ω–æ–º—É —Ä–∞–∑–¥–µ–ª—É - —Å–æ–∑–¥–∞—ë–º –¥–ª—è –Ω–µ–≥–æ –∫–Ω–æ–ø–∫—É
      const warehouseId = `warehouse-${wh.id}`;
      let btn = header.querySelector(`[data-section="${warehouseId}"]`);
      if (!btn) {
        // –ö–Ω–æ–ø–∫–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞—ë–º –µ—ë
        btn = document.createElement('button');
        btn.className = 'tab-btn';
        btn.setAttribute('data-section', warehouseId);
        btn.textContent = wh.name;
        // –í—Å—Ç–∞–≤–ª—è–µ–º –µ—ë –ø–µ—Ä–µ–¥ divider'–æ–º (–ø–µ—Ä–µ–¥ flex:1)
        const divider = header.querySelector('[style*="flex:1"]');
        if (divider) {
          header.insertBefore(btn, divider);
        } else {
          header.appendChild(btn);
        }
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
        btn.addEventListener('click', ()=> handleWarehouseTabClick(btn));
      } else {
        // –ö–Ω–æ–ø–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
        btn.textContent = wh.name;
      }
    }
  });
}

function sectionImageFor(id){
  const map = { buffer: '1.jpg', south: '2.jpg', north: '3.jpg', ready: '4.jpg' };
  return map[id] || '1.jpg';
}

// Helper function to get warehouse_id from section ID (both standard and new warehouses)
function getWarehouseIdFromSection(sectionId){
  // If it's a standard section, use SECTION_TO_WAREHOUSE
  if(SECTION_TO_WAREHOUSE[sectionId]){
    return SECTION_TO_WAREHOUSE[sectionId];
  }
  // If it's a new warehouse (warehouse-N format), extract N
  if(sectionId.startsWith('warehouse-')){
    const id = parseInt(sectionId.substring(10));
    return isNaN(id) ? 1 : id;
  }
  // Default to buffer
  return SECTION_TO_WAREHOUSE['buffer'] || 1;
}

async function fetchCameraTypes(){
  try{
    const resp = await fetch('cameras_api.php?types=1', { cache: 'no-store' });
    if(!resp.ok) return [];
    const data = await resp.json();
    CAMERA_TYPES = data.types || [];
    return CAMERA_TYPES;
  }catch(e){ console.error('types load error', e); return []; }
}

async function loadCamerasForWarehouse(wid, sectionId){
  const container = document.getElementById('preview-cameras');
  if(!container) return;
  container.innerHTML = '<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–º–µ—Ä...</div>';
  await fetchCameraTypes();
  CURRENT_WAREHOUSE_ID = wid;
  // update preview image
  const pi = document.getElementById('preview-img'); if(pi) pi.src = sectionImageFor(sectionId);
  try{
    const resp = await fetch('cameras_api.php?warehouse_id=' + encodeURIComponent(wid), { cache: 'no-store' });
    if(!resp.ok){ container.innerHTML = '<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; return; }
    const data = await resp.json();
    const cams = data.cameras || [];
    container.innerHTML = '';
    
    // –§–æ—Ä–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –∫–∞–º–µ—Ä—ã
    const addForm = document.createElement('div');
    addForm.className = 'camera-form';
    addForm.innerHTML = `
      <div class="row form-header"><div><strong>‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–∞–º–µ—Ä—É</strong></div></div>
      <div class="row"><div>IP/Host</div><div><input type="text" class="add-ip-input" placeholder="192.168.1.100" style="width:100%"></div></div>
      <div class="row"><div>–õ–æ–≥–∏–Ω</div><div><input type="text" class="add-login-input" placeholder="admin" style="width:100%"></div></div>
      <div class="row"><div>–ü–∞—Ä–æ–ª—å</div><div><input type="password" class="add-pass-input" placeholder="–ø–∞—Ä–æ–ª—å" style="width:100%"></div></div>
      <div class="row"><div>–¢–∏–ø</div><div><select class="add-type-select" style="width:100%"></select></div></div>
      <div class="row"><div></div><div><button class="add-camera">–î–æ–±–∞–≤–∏—Ç—å</button></div></div>
    `;
    container.appendChild(addForm);
    
    // Populate types in add form
    const addTypeSelect = addForm.querySelector('.add-type-select');
    CAMERA_TYPES.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.id;
      opt.textContent = (t.description && t.description.length) ? t.description : ('–¢–∏–ø #' + t.id);
      addTypeSelect.appendChild(opt);
    });
    
    // Add camera button handler
    addForm.querySelector('.add-camera').addEventListener('click', async ()=>{
      const hostPart = addForm.querySelector('.add-ip-input').value.trim();
      const login = addForm.querySelector('.add-login-input').value.trim();
      const pass = addForm.querySelector('.add-pass-input').value;
      const typeId = addTypeSelect.value;
      
      if(!hostPart){ flash('IP/Host –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'); return; }
      
      // Build RTSP URL
      let hp = hostPart.replace(/^\s+|\s+$/g, '');
      hp = hp.replace(/^\w+:\/\//,'');
      hp = hp.replace(/^[^@]+@/,'');
      const full = 'rtsp://' + (login ? (encodeURIComponent(login) + (pass ? ':' + encodeURIComponent(pass) : '') + '@') : '') + hp + '/live';
      
      try{
        const resp = await fetch('cameras_api.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'add', warehouse_id: wid, ip_camera: full, camera_type_id: typeId })
        });
        if(!resp.ok) { flash('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã'); return; }
        const r = await resp.json();
        if(r.ok){
          flash('–ö–∞–º–µ—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
          // Clear form
          addForm.querySelector('.add-ip-input').value = '';
          addForm.querySelector('.add-login-input').value = '';
          addForm.querySelector('.add-pass-input').value = '';
          // Reload cameras
          loadCamerasForWarehouse(wid, sectionId);
        } else {
          flash('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
        }
      }catch(e){ console.error(e); flash('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
    });
    
    // Display existing cameras
    if(cams.length > 0){
      cams.forEach(cam => renderCameraForm(container, cam));
    }
  }catch(e){ console.error(e); container.innerHTML = '<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; }
}

// Fade in on page load with minimal animation
window.addEventListener('load', ()=>{
  document.body.style.opacity = '1';
  document.body.style.transition = 'opacity 150ms ease';
});
document.body.style.opacity = '0';

// Restore preview image from sessionStorage but DO NOT auto-load forms
const savedSection = sessionStorage.getItem('currentSection') || 'buffer';
const previewImg = document.getElementById('preview-img');
if(previewImg){
  previewImg.src = sectionImageFor(savedSection);
}

function renderCameraForm(container, cam){
  const div = document.createElement('div');
  div.className = 'camera-form';
  // parse existing ip_camera into host, login, password
  function parseRtsp(url){
    if(!url) return {host:'', login:'', password:''};
    try{
      // remove surrounding whitespace
      let s = String(url).trim();
      // Remove /live from the end if present
      s = s.replace(/\/live$/i, '');
      // make sure scheme exists for parsing
      if(!/^\w+:\/\//.test(s)) s = 'rtsp://' + s;
      // regex: scheme://[user:pass@]host/path
      const m = s.match(/^(\w+:\/\/)(?:([^:@\/]+)(?::([^@\/]+))?@)?(.+)$/);
      if(!m) return {host: s, login:'', password:''};
      return {host: m[4], login: m[2]||'', password: m[3]||''};
    }catch(e){ return {host: url, login:'', password:''}; }
  }

  const parsed = parseRtsp(cam.ip_camera || '');

  div.innerHTML = `
    <div class="row form-header"><div><strong>üì∑ –ö–∞–º–µ—Ä–∞ #${cam.id}</strong></div></div>
    <div class="row"><div>IP/Host</div><div><input type="text" class="ip-input" value="${parsed.host||''}" style="width:100%" disabled></div></div>
    <div class="row"><div>–õ–æ–≥–∏–Ω</div><div><input type="text" class="login-input" value="${parsed.login||''}" style="width:100%" disabled></div></div>
    <div class="row"><div>–ü–∞—Ä–æ–ª—å</div><div><input type="password" class="pass-input" value="${parsed.password||''}" style="width:100%" disabled></div></div>
    <div class="row"><div>–¢–∏–ø</div><div><select class="type-select" style="width:100%" disabled></select></div></div>
    <div class="row"><div></div><div><button class="edit-camera" data-mode="view">–ò–∑–º–µ–Ω–∏—Ç—å</button><button class="delete-camera">–£–¥–∞–ª–∏—Ç—å</button></div></div>
  `;

  // populate types
  const sel = div.querySelector('.type-select');
  CAMERA_TYPES.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t.id;
    opt.textContent = (t.description && t.description.length) ? t.description : ('–¢–∏–ø #' + t.id);
    if (cam.camera_type_id && Number(cam.camera_type_id) === Number(t.id)) opt.selected = true;
    sel.appendChild(opt);
  });

  // edit/save toggle
  const editBtn = div.querySelector('.edit-camera');
  const ipInput = div.querySelector('.ip-input');
  const loginInput = div.querySelector('.login-input');
  const passInput = div.querySelector('.pass-input');
  ipInput.disabled = true;
  loginInput.disabled = true;
  passInput.disabled = true;
  sel.disabled = true;

  editBtn.addEventListener('click', async ()=>{
    if (editBtn.dataset.mode === 'view') {
      // switch to edit mode
      editBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
      editBtn.dataset.mode = 'edit';
      ipInput.disabled = false;
      loginInput.disabled = false;
      passInput.disabled = false;
      sel.disabled = false;
      ipInput.focus();
      return;
    }

    // save mode ‚Äî build RTSP URL from fields and send as ip_camera
    const hostPart = ipInput.value.trim();
    const login = loginInput.value.trim();
    const pass = passInput.value;
    const typeId = sel.value;

    if(!hostPart){ flash('IP/Host –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'); return; }

    // normalize hostPart (remove scheme and credentials if present)
    let hp = hostPart.replace(/^\s+|\s+$/g, '');
    hp = hp.replace(/^\w+:\/\//,'');
    hp = hp.replace(/^[^@]+@/,'');
    // build full url with /live at the end
    const full = 'rtsp://' + (login ? (encodeURIComponent(login) + (pass ? ':' + encodeURIComponent(pass) : '') + '@') : '') + hp + '/live';

    try{
      const resp = await fetch('cameras_api.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: cam.id, ip_camera: full, camera_type_id: typeId })
      });
      if(!resp.ok) { flash('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã'); return; }
      const r = await resp.json();
      if(r.ok){
        flash('–ö–∞–º–µ—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
        // return to view mode
        editBtn.textContent = '–ò–∑–º–µ–Ω–∏—Ç—å';
        editBtn.dataset.mode = 'view';
        ipInput.disabled = true;
        loginInput.disabled = true;
        passInput.disabled = true;
        sel.disabled = true;
        // refresh list
          // reload cameras for current warehouse (use session or CURRENT_WAREHOUSE_ID)
          const sec2 = sessionStorage.getItem('currentSection') || 'buffer';
          const widReload = CURRENT_WAREHOUSE_ID || SECTION_TO_WAREHOUSE[sec2];
          if(widReload) loadCamerasForWarehouse(widReload, sec2);
      } else {
        flash('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ—É—Å–ø–µ—à–Ω–æ');
      }
    }catch(e){ console.error(e); flash('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
  });

  // Delete camera button
  const deleteBtn = div.querySelector('.delete-camera');
  deleteBtn.addEventListener('click', async ()=>{
    if(!confirm(`–£–¥–∞–ª–∏—Ç—å –∫–∞–º–µ—Ä—É #${cam.id}?`)) return;
    
    try{
      const resp = await fetch('cameras_api.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'delete', id: cam.id })
      });
      if(!resp.ok) { flash('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã'); return; }
      const r = await resp.json();
      if(r.ok){
        flash('–ö–∞–º–µ—Ä–∞ —É–¥–∞–ª–µ–Ω–∞');
        // Reload cameras for current warehouse
        const sec2 = sessionStorage.getItem('currentSection') || 'buffer';
        const widReload = CURRENT_WAREHOUSE_ID || getWarehouseIdFromSection(sec2);
        if(widReload) loadCamerasForWarehouse(widReload, sec2);
      } else {
        flash('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
      }
    }catch(e){ console.error(e); flash('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
  });

  container.appendChild(div);
}

async function loadCamerasForSection(sectionId){
  const container = document.getElementById('preview-cameras');
  if(!container) return;
  container.innerHTML = '<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–º–µ—Ä...</div>';
  await fetchCameraTypes();
  const wid = SECTION_TO_WAREHOUSE[sectionId];
  // update preview image
  const pi = document.getElementById('preview-img'); if(pi) pi.src = sectionImageFor(sectionId);
  try{
    const resp = await fetch('cameras_api.php?warehouse_id=' + encodeURIComponent(wid), { cache: 'no-store' });
    if(!resp.ok){ container.innerHTML = '<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; return; }
    const data = await resp.json();
    const cams = data.cameras || [];
    container.innerHTML = '';
    if(cams.length === 0){ container.innerHTML = '<div class="muted">–ö–∞–º–µ—Ä—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–ª—è —ç—Ç–æ–≥–æ —Å–∫–ª–∞–¥–∞</div>'; container.dataset.section = sectionId; return; }
    // store section id for reload
    container.dataset.section = sectionId;
    cams.forEach(cam => renderCameraForm(container, cam));
  }catch(e){ console.error(e); container.innerHTML = '<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; }
}

async function loadAllCameras(){
  const container = document.getElementById('preview-cameras');
  if(!container) return;
  container.innerHTML = '<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–º–µ—Ä...</div>';
  await fetchCameraTypes();
  container.innerHTML = '';
  
  try{
    for(const [sectionId, wid] of Object.entries(SECTION_TO_WAREHOUSE)) {
      const resp = await fetch('cameras_api.php?warehouse_id=' + encodeURIComponent(wid), { cache: 'no-store' });
      if(!resp.ok) continue;
      const data = await resp.json();
      const cams = data.cameras || [];
      
      if(cams.length > 0) {
        // Add warehouse section header
        const header = document.createElement('div');
        header.style.marginTop = '14px';
        header.style.marginBottom = '8px';
        header.innerHTML = `<strong style="color:#666;font-size:0.95rem;">${WAREHOUSE_NAMES[wid] || '–°–∫–ª–∞–¥ ' + wid}</strong>`;
        container.appendChild(header);
        
        cams.forEach(cam => renderCameraForm(container, cam));
      }
    }
    
    if(container.children.length === 0) {
      container.innerHTML = '<div class="muted">–ö–∞–º–µ—Ä—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã</div>';
    }
  }catch(e){ console.error(e); container.innerHTML = '<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; }
}

// Back button ‚Äî save current section and navigate to index with fade
document.getElementById('back-btn').addEventListener('click', ()=>{
  // Save the currently active section and navigate back with explicit param
  const activeSection = document.querySelector('header button.tab-btn.active');
  const sectionId = activeSection ? activeSection.dataset.section : (sessionStorage.getItem('currentSection') || 'buffer');
  // Also keep sessionStorage in sync
  sessionStorage.setItem('currentSection', sectionId);
  document.body.style.opacity = '0';
  document.body.style.transition = 'opacity 200ms ease';
  setTimeout(()=> { window.location.href = 'index.html'; }, 200);
});

// header tab switching for warehouses ‚Äî load cameras for selected warehouse only
// Function to handle warehouse tab click
function handleWarehouseTabClick(btn){
  document.querySelectorAll('header .tab-btn').forEach(b=> b.classList.remove('active'));
  btn.classList.add('active');
  // change preview image
  const sec = btn.dataset.section;
  const pi = document.getElementById('preview-img');
  if(pi) pi.src = sectionImageFor(sec);
  // save selection so when opening settings from main it stays consistent
  sessionStorage.setItem('currentSection', sec);
  // If a component is active (e.g. cameras or warehouses) then load corresponding settings
  const activeComp = document.querySelector('#right-sections button.active');
  const wid = getWarehouseIdFromSection(sec); // Use helper function instead of SECTION_TO_WAREHOUSE
  CURRENT_WAREHOUSE_ID = wid;
  const container = document.getElementById('preview-cameras');
  
  if(activeComp && activeComp.dataset.component === 'cameras'){
    loadCamerasForWarehouse(wid, sec);
  } else if(activeComp && activeComp.dataset.component === 'warehouses'){
    // Reload warehouses list (it shows all warehouses, not warehouse-specific)
    loadWarehouses();
  } else {
    if(container) container.innerHTML = '<div class="muted">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–ø—Ä–∞–≤–∞, —á—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å</div>';
  }
}

document.querySelectorAll('header .tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=> handleWarehouseTabClick(btn));
});

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∫–ª–∞–¥–∞–º–∏
function renderWarehouseForm(container, wh){
  const div = document.createElement('div');
  div.className = 'camera-form';
  div.innerHTML = `
    <div class="row form-header"><div><strong>üè≠ –°–∫–ª–∞–¥ #${wh.id}: ${wh.name}</strong></div></div>
    <div class="row"><div>–ù–∞–∑–≤–∞–Ω–∏–µ</div><div><input type="text" class="wh-name-input" value="${wh.name || ''}" style="width:100%" disabled></div></div>
    <div class="row"><div>–¢–∏–ø</div><div><input type="text" class="wh-type-input" value="${wh.type || ''}" style="width:100%" disabled></div></div>
    <div class="row"><div>–ó–∞–µ–∑–¥—ã</div><div style="padding:8px;" id="wh-arrivals-${wh.id}">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
    <div class="row"><div></div><div><button class="edit-warehouse" data-mode="view" data-id="${wh.id}">–ò–∑–º–µ–Ω–∏—Ç—å</button><button class="delete-warehouse" data-id="${wh.id}">–£–¥–∞–ª–∏—Ç—å</button></div></div>
  `;

  // edit/save toggle
  const editBtn = div.querySelector('.edit-warehouse');
  const nameInput = div.querySelector('.wh-name-input');
  const typeInput = div.querySelector('.wh-type-input');
  nameInput.disabled = true;
  typeInput.disabled = true;

  editBtn.addEventListener('click', async ()=>{
    if (editBtn.dataset.mode === 'view') {
      // switch to edit mode
      editBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
      editBtn.dataset.mode = 'edit';
      nameInput.disabled = false;
      typeInput.disabled = false;
      nameInput.focus();
      return;
    }

    // save mode
    const name = nameInput.value.trim();
    const type = typeInput.value.trim();

    if(!name){ flash('–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ'); return; }

    try{
      const resp = await fetch('warehouses_api.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'rename', id: wh.id, name: name, type: type })
      });
      if(!resp.ok) { flash('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'); return; }
      const r = await resp.json();
      if(r.ok){
        flash('–°–∫–ª–∞–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
        // return to view mode
        editBtn.textContent = '–ò–∑–º–µ–Ω–∏—Ç—å';
        editBtn.dataset.mode = 'view';
        nameInput.disabled = true;
        typeInput.disabled = true;
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è —Å–∫–ª–∞–¥–æ–≤ –≤ header
        await loadWarehouseNames();
        // reload warehouses
        loadWarehouses();
      } else {
        flash('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
      }
    }catch(e){ console.error(e); flash('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
  });

  // –£–¥–∞–ª–µ–Ω–∏–µ
  div.querySelector('.delete-warehouse').addEventListener('click', async ()=>{
    try{
      const resp = await fetch('warehouses_api.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'delete', id: wh.id })
      });
      if(!resp.ok){
        const errData = await resp.json();
        if(errData.error === 'has_arrivals'){
          // –¢—Ä–µ–±—É–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
          const confirm_text = prompt(`${errData.message}\n\n–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∫–ª–∞–¥–∞ —Ç–æ—á–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:\n"${wh.name}"`);
          if(!confirm_text || confirm_text !== wh.name){
            flash('–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
            return;
          }
          // –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º
          const resp2 = await fetch('warehouses_api.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'delete', id: wh.id, confirm: true })
          });
          if(!resp2.ok){ flash('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'); return; }
          const r2 = await resp2.json();
          if(r2.ok){
            flash('–°–∫–ª–∞–¥ —É–¥–∞–ª–µ–Ω');
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è —Å–∫–ª–∞–¥–æ–≤ –≤ header
            await loadWarehouseNames();
            loadWarehouses();
          } else {
            flash('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
          }
        } else {
          flash('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
        }
        return;
      }
      const r = await resp.json();
      if(r.ok){
        flash('–°–∫–ª–∞–¥ —É–¥–∞–ª–µ–Ω');
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è —Å–∫–ª–∞–¥–æ–≤ –≤ header
        await loadWarehouseNames();
        loadWarehouses();
      } else {
        flash('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
      }
    }catch(e){ console.error(e); flash('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
  });

  container.appendChild(div);
}

async function loadWarehouses(){
  const container = document.getElementById('preview-cameras');
  if(!container) return;
  container.innerHTML = '<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫–ª–∞–¥–æ–≤...</div>';
  try{
    const resp = await fetch('warehouses_api.php', { cache: 'no-store' });
    if(!resp.ok){ container.innerHTML = '<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; return; }
    const data = await resp.json();
    const warehouses = data.warehouses || [];
    container.innerHTML = '';
    
    // –§–æ—Ä–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å–∫–ª–∞–¥–∞
    const addForm = document.createElement('div');
    addForm.className = 'camera-form';
    addForm.innerHTML = `
      <div class="row form-header"><div><strong>‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å–∫–ª–∞–¥</strong></div></div>
      <div class="row"><div>–ù–∞–∑–≤–∞–Ω–∏–µ</div><div><input type="text" class="wh-name-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∫–ª–∞–¥–∞" style="width:100%"></div></div>
      <div class="row"><div>–¢–∏–ø</div><div><input type="text" class="wh-type-input" placeholder="–¢–∏–ø —Å–∫–ª–∞–¥–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" style="width:100%"></div></div>
      <div class="row"><div></div><div><button class="add-warehouse">–î–æ–±–∞–≤–∏—Ç—å</button></div></div>
    `;
    container.appendChild(addForm);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    addForm.querySelector('.add-warehouse').addEventListener('click', async ()=>{
      const name = addForm.querySelector('.wh-name-input').value.trim();
      const type = addForm.querySelector('.wh-type-input').value.trim();
      if(!name){ flash('–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ'); return; }
      
      try{
        const resp = await fetch('warehouses_api.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'add', name: name, type: type })
        });
        if(!resp.ok){ flash('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è'); return; }
        const r = await resp.json();
        if(r.ok){
          flash('–°–∫–ª–∞–¥ –¥–æ–±–∞–≤–ª–µ–Ω');
          addForm.querySelector('.wh-name-input').value = '';
          addForm.querySelector('.wh-type-input').value = '';
          // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è —Å–∫–ª–∞–¥–æ–≤ –≤ header
          await loadWarehouseNames();
          loadWarehouses();
        } else {
          flash('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
        }
      }catch(e){ console.error(e); flash('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
    });
    
    // –°–ø–∏—Å–æ–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–∫–ª–∞–¥–æ–≤
    if(warehouses.length > 0){
      warehouses.forEach(wh => {
        renderWarehouseForm(container, wh);
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–µ–∑–¥–æ–≤
        checkArrivalsCount(wh.id);
      });
    }
  }catch(e){ console.error(e); container.innerHTML = '<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; }
}

async function checkArrivalsCount(whId){
  try{
    const elem = document.getElementById(`wh-arrivals-${whId}`);
    if(!elem) return;
    
    const resp = await fetch('warehouses_api.php?warehouse_id=' + whId, { cache: 'no-store' });
    if(!resp.ok){
      elem.textContent = '? –∑–∞–µ–∑–¥(–æ–≤)';
      return;
    }
    const data = await resp.json();
    const count = data.arrivals_count || 0;
    elem.textContent = count + ' –∑–∞–µ–∑–¥(–æ–≤)';
  }catch(e){ console.error(e); }
}

document.addEventListener('DOMContentLoaded', async ()=>{
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è —Å–∫–ª–∞–¥–æ–≤ –∏–∑ –ë–î
  await loadWarehouseNames();
  
  const right = document.getElementById('right-sections');
  // Build right panel with components
  const components = [
    { id: 'cameras', label: 'üì∑ –ö–∞–º–µ—Ä—ã', icon: 'üé•' },
    { id: 'warehouses', label: 'üè≠ –°–∫–ª–∞–¥—ã', icon: 'üè¢' }
  ];
  
  components.forEach(comp => {
    const btn = document.createElement('button');
    btn.className = 'tab-btn';
    // do not auto-activate components (user must click to open settings)
    btn.style.textAlign = 'left';
    btn.style.fontSize = '1rem';
    btn.textContent = comp.label;
    btn.dataset.component = comp.id;
    btn.addEventListener('click', ()=>{
      // mark active in right panel
      right.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      // Save active component
      sessionStorage.setItem('activeComponent', comp.id);
      
      if(comp.id === 'cameras'){
        // –î–ª—è –∫–∞–º–µ—Ä –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å–∫–ª–∞–¥–∞
        const activeWarehouse = document.querySelector('header .tab-btn.active');
        if(activeWarehouse) {
          const wid = getWarehouseIdFromSection(activeWarehouse.dataset.section); // Use helper function
          loadCamerasForWarehouse(wid, activeWarehouse.dataset.section);
        }
      } else if(comp.id === 'warehouses'){
        // –î–ª—è —Å–∫–ª–∞–¥–æ–≤ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–∫–ª–∞–¥–æ–≤
        loadWarehouses();
      }
    });
    right.appendChild(btn);
  });
  
  // Set active warehouse tab from session (but DO NOT auto-load component settings)
  const savedSection = sessionStorage.getItem('currentSection') || 'buffer';
  document.querySelectorAll('header .tab-btn').forEach(b=> b.classList.remove('active'));
  const headBtn = document.querySelector(`header .tab-btn[data-section="${savedSection}"]`);
  if(headBtn) headBtn.classList.add('active');
  // show preview image for saved section
  const wid = getWarehouseIdFromSection(savedSection); // Use helper function
  CURRENT_WAREHOUSE_ID = wid;
  const pi = document.getElementById('preview-img'); if(pi) pi.src = sectionImageFor(savedSection);
  
  // Restore active component from session
  const savedComponent = sessionStorage.getItem('activeComponent');
  if(savedComponent){
    const compBtn = document.querySelector(`#right-sections button[data-component="${savedComponent}"]`);
    if(compBtn) compBtn.click();
  } else {
    // leave preview-cameras empty and prompt user to choose a component
    const container = document.getElementById('preview-cameras');
    if(container) container.innerHTML = '<div class="muted">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–ø—Ä–∞–≤–∞, —á—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å</div>';
  }
});

// simple notifier
function flash(msg){ alert(msg); }

// Fullscreen for images
function openFullscreen(src){
  const fs = document.getElementById('fullscreen');
  fs.style.display='flex'; fs.setAttribute('aria-hidden','false');
  fs.querySelector('img').src = src;
}
document.querySelector('.close-btn').addEventListener('click', ()=>{ 
  const fs = document.getElementById('fullscreen'); 
  fs.style.display='none'; 
  fs.setAttribute('aria-hidden','true'); 
});
document.getElementById('fullscreen').addEventListener('click',(e)=>{ 
  if(e.target.id==='fullscreen') { 
    e.currentTarget.style.display='none'; 
    e.currentTarget.setAttribute('aria-hidden','true'); 
  } 
});

// Click/keyboard on camera
document.querySelectorAll('.camera').forEach(cam=>{
  const img = cam.querySelector('img');
  cam.addEventListener('click', ()=> openFullscreen(img.src));
  cam.addEventListener('keydown', (e)=> { 
    if(e.key==='Enter'||e.key===' ') openFullscreen(img.src); 
  });
});
</script>
</body>
</html>
